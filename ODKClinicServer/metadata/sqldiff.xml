<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqldiff PUBLIC "-//OpenMRS//DTD OpenMRS SQL Diff Config 1.0//EN" "http://resources.openmrs.org/doctype/sqldiff-1.0.dtd">
<sqldiff version="1.0">
	
	<diff>
		<version>1.0</version>
		<author>UW ICTD</author>
		<date>February 5 2010</date>
		<description>
			Creating the revision token tables and triggers
		</description>
		<sql>
		DROP TABLE IF EXISTS odkclinic_obs;
		CREATE TABLE odkclinic_obs (
			  id int(11) NOT NULL,
			  revision_token datetime NOT NULL default '0000-00-00 00:00:00',
			  PRIMARY KEY  (id)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
		
		DROP TABLE IF EXISTS odkclinic_encounter;
		CREATE TABLE odkclinic_encounter (
			id int NOT NULL,
			revision_token datetime NOT NULL default '0000-00-00 00:00:00',
			PRIMARY KEY (id)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
			
		DROP TRIGGER IF EXISTS obs_insert;	
		CREATE TRIGGER obs_insert BEFORE INSERT ON obs
			FOR EACH ROW
			INSERT INTO odkclinic_obs(id,revision_token) VALUES (NEW.obs_id, NOW());
		
		DROP TRIGGER IF EXISTS encounter_trigger;
		DROP TRIGGER IF EXISTS encounter_insert
		CREATE TRIGGER encounter_insert BEFORE INSERT ON encounter
			FOR EACH ROW
			INSERT INTO odkclinic_encounter(id, revision_token) VALUES (NEW.encounter_id, NOW());
		
		DROP TRIGGER IF EXISTS encounter_delete;
		CREATE TRIGGER encounter_delete BEFORE DELETE ON encounter
		    FOR EACH ROW
		    DELETE FROM odkclinic_encounter WHERE id = OLD.encounter_id;
		
		DROP TRIGGER IF EXISTS obs_delete;
		CREATE TRIGGER obs_delete BEFORE DELETE ON obs
		    FOR EACH ROW
		    DELETE FROM odkclinic_obs WHERE id = OLD.obs_id;
		
		
		DROP TRIGGER IF EXISTS obs_update;
		CREATE TRIGGER obs_update AFTER UPDATE ON obs 
			FOR EACH ROW
			UPDATE odkclinic_obs SET odkclinic_obs.revision_token = NOW() 
			WHERE NEW.obs_id = odkclinic_obs.id;
		
		DROP TRIGGER IF EXISTS enc_update;
		CREATE TRIGGER enc_update AFTER UPDATE ON encounter
		    FOR EACH ROW
			UPDATE odkclinic_encounter SET odkclinic_encounter.revision_token = NOW() 
			WHERE NEW.encounter_id = odkclinic_encounter.id;
		
		<!-- unretire NOTES -->
		UPDATE concept SET retired = 0 WHERE concept_id = 5097;
		 
        INSERT INTO cohort(cohort_id,name,creator,voided,date_created,uuid) VALUES(1,'PRIME',1,0,'2009-06-02 00:00:00','wakka-wakka-wakka'); 
        INSERT INTO cohort_member(cohort_id,patient_id) VALUES(1,2); 
        INSERT INTO cohort_member(cohort_id,patient_id) VALUES(1,3); 
        INSERT INTO encounter(encounter_id,patient_id,location_id,provider_id,creator,uuid) VALUES(1,2,1,1,1,'zip-zop-zoopity-bob'); 
        INSERT INTO encounter(encounter_id,patient_id,location_id,provider_id,creator,uuid) VALUES(2,3,1,1,1,'whoaaahh-hoo'); 
        INSERT INTO obs(obs_id,person_id,concept_id,encounter_id,location_id,value_numeric,creator,voided,date_created,uuid) VALUES(1,2,5497,1,1,490,1,0,'2009-07-23 00:00:00','crazy eric');
        INSERT INTO obs(obs_id,person_id,concept_id,encounter_id,location_id,value_numeric,creator,voided,date_created,uuid) VALUES(2,2,5497,1,1,560,1,0,'2009-07-24 00:00:00','crazy erics');
        INSERT INTO obs(obs_id,person_id,concept_id,encounter_id,location_id,value_numeric,creator,voided,date_created,uuid) VALUES(3,2,5497,1,1,720,1,0,'2009-07-25 00:00:00','crazy ericz');
        INSERT INTO obs(obs_id,person_id,concept_id,encounter_id,location_id,value_numeric,creator,voided,date_created,uuid) VALUES(4,3,5497,2,1,500,1,0,'2009-07-23 00:00:00','do it');
        INSERT INTO obs(obs_id,person_id,concept_id,encounter_id,location_id,value_numeric,creator,voided,date_created,uuid) VALUES(5,3,5497,2,1,510,1,0,'2009-07-24 00:00:00','man');
        INSERT INTO obs(obs_id,person_id,concept_id,encounter_id,location_id,value_numeric,creator,voided,date_created,uuid) VALUES(6,3,5497,2,1,550,1,0,'2009-07-25 00:00:00','you are');
        INSERT INTO obs(obs_id,person_id,concept_id,encounter_id,location_id,value_text,creator,voided,date_created,uuid) VALUES(7,2,5097,1,1,'This Patient is WOW',1,0,'2009-07-23 00:00:00', 'a'); 
        INSERT INTO obs(obs_id,person_id,concept_id,encounter_id,location_id,value_text,creator,voided,date_created,uuid) VALUES(8,2,5097,1,1,'This Patient is something',1,0,'2009-07-24 00:00:00', 'b'); 
        INSERT INTO obs(obs_id,person_id,concept_id,encounter_id,location_id,value_text,creator,voided,date_created,uuid) VALUES(9,3,5097,2,1,'This Patient is not WOW',1,0,'2009-07-23 00:00:00', 'c'); 
        INSERT INTO obs(obs_id,person_id,concept_id,encounter_id,location_id,value_text,creator,voided,date_created,uuid) VALUES(10,3,5097,2,1,'This Patient is not something',1,0,'2009-07-24 00:00:00', 'd'); 
        INSERT INTO program(program_id,concept_id,name,creator,uuid) VALUES(4,5497,'HIV CD4 thing',1,'yeah'); 
        INSERT INTO program(program_id,concept_id,name,creator,uuid) VALUES(5,5097,'Note thing',1,'think'); 
        INSERT INTO patient_program(patient_program_id,patient_id,program_id,creator,uuid) VALUES(9,2,4,1,'yup yup'); 
        INSERT INTO patient_program(patient_program_id,patient_id,program_id,creator,uuid) VALUES(10,2,5,1,'nope nope'); 
		INSERT INTO patient_program(patient_program_id,patient_id,program_id,creator,uuid) VALUES(11,3,4,1,'yes sir');
		INSERT INTO patient_program(patient_program_id,patient_id,program_id,creator,uuid) VALUES(12,3,5,1,'no sir');  
		
        
        <!-- 
        INSERT INTO client_observation(obs_id,observation_patient_id,observation_concept_id,observation_encounter_id,value_numeric,creator,voided,observation_date_created,isUpdate) VALUES(2,1,4,1,110,1,0,'2009-04-23 00:00:00', 1); 
        INSERT INTO client_observation(obs_id,observation_patient_id,observation_concept_id,observation_encounter_id,value_numeric,creator,voided,observation_date_created,isUpdate) VALUES(3,1,4,1,122,1,0,'2009-03-25 00:00:00', 1); 
        INSERT INTO client_observation(obs_id,observation_patient_id,observation_concept_id,observation_encounter_id,value_numeric,creator,voided,observation_date_created,isUpdate) VALUES(4,1,4,1,130,1,0,'2009-01-22 00:00:00', 1); 
        INSERT INTO client_observation(obs_id,observation_patient_id,observation_concept_id,observation_encounter_id,value_numeric,creator,voided,observation_date_created,isUpdate) VALUES(5,2,4,2,120,1,0,'2009-01-23 00:00:00', 1); 
        INSERT INTO client_observation(obs_id,observation_patient_id,observation_concept_id,observation_encounter_id,value_numeric,creator,voided,observation_date_created,isUpdate) VALUES(6,2,4,2,125,1,0,'2009-03-03 00:00:00', 1); 
        INSERT INTO client_observation(obs_id,observation_patient_id,observation_concept_id,observation_encounter_id,value_numeric,creator,voided,observation_date_created,isUpdate) VALUES(7,2,4,2,130,1,0,'2009-05-23 00:00:00', 1); 
        -->
		
		<!--
        INSERT INTO client_observation(obs_id,observation_patient_id,observation_concept_id,observation_encounter_id,value_boolean,creator,voided,observation_date_created,isUpdate) VALUES(22,1,1,2,0,1,0,'2009-04-32 00:00:00', 1); 
        INSERT INTO client_observation(obs_id,observation_patient_id,observation_concept_id,observation_encounter_id,value_boolean,creator,voided,observation_date_created,isUpdate) VALUES(23,1,1,2,1,1,0,'2009-06-32 00:00:00', 1); 
        INSERT INTO client_observation(obs_id,observation_patient_id,observation_concept_id,observation_encounter_id,value_boolean,creator,voided,observation_date_created,isUpdate) VALUES(24,1,1,2,0,1,0,'2009-07-32 00:00:00', 1); 
        INSERT INTO client_observation(obs_id,observation_patient_id,observation_concept_id,observation_encounter_id,value_boolean,creator,voided,observation_date_created,isUpdate) VALUES(25,2,1,2,0,1,0,'2009-04-32 00:00:00', 1); 
        INSERT INTO client_observation(obs_id,observation_patient_id,observation_concept_id,observation_encounter_id,value_boolean,creator,voided,observation_date_created,isUpdate) VALUES(26,2,1,2,1,1,0,'2009-06-32 00:00:00', 1); 
        INSERT INTO client_observation(obs_id,observation_patient_id,observation_concept_id,observation_encounter_id,value_boolean,creator,voided,observation_date_created,isUpdate) VALUES(27,2,1,2,0,1,0,'2009-07-32 00:00:00', 1);
        --> 
        
        
		</sql>
	</diff>
</sqldiff>