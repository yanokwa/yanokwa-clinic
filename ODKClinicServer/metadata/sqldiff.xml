<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqldiff PUBLIC "-//OpenMRS//DTD OpenMRS SQL Diff Config 1.0//EN" "http://resources.openmrs.org/doctype/sqldiff-1.0.dtd">
<sqldiff version="1.0">
	
	<diff>
		<version>1.0</version>
		<author>Owen Kim</author>
		<date>February 5 2010</date>
		<description>
			Creating the revision token tables and triggers
		</description>
		<sql>
		
		CREATE TABLE IF NOT EXISTS `odkclinic_obs` (
			  `id` int(11) NOT NULL,
			  `revision_token` datetime NOT NULL default '0000-00-00 00:00:00',
			  PRIMARY KEY  (`id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
		
		CREATE TABLE IF NOT EXISTS `odkclinic_encounter` (
			`id` int NOT NULL,
			`revision_token` datetime NOT NULL default '0000-00-00 00:00:00',
			PRIMARY KEY (`id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
			
		CREATE TRIGGER obs_insert AFTER INSERT ON obs
			FOR EACH ROW
			INSERT INTO odkclinic_obs(id,revision_token) VALUES (NEW.id, NOW());
			
		CREATE TRIGGER encounter_trigger AFTER INSERT ON encounter
			FOR EACH ROW
			INSERT INTO odkclinic_encounter(id, revision_token) VALUES (NEW.id, NOW();
			
		CREATE TRIGGER obs_update AFTER UPDATE ON obs 
			FOR EACH ROW
			UPDATE odkclinic_obs SET odkclinic_obs.revision_token = NOW() 
			WHERE NEW.id = odkclinic_obs.id;
			
		CREATE TRIGGER enc_update AFTER UPDATE ON encounter
			UPDATE odkclinic_encounter SET odkclinic_encounter.revision_token = NOW() 
			WHERE NEW.id = odkclinic_encounter.id;
		
		
		</sql>
	</diff>
</sqldiff>